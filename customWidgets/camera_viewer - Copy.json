{
  "fqn": "camera_viewer_preserve_ui",
  "name": "Camera Viewer (Preserve UI)",
  "deprecated": false,
  "image": "",
  "description": "Giữ nguyên giao diện gốc khi tắt (icon mắt gạch chéo); khi bật sẽ hiển webcam bằng JS thuần.",
  "descriptor": {
    "type": "static",
    "sizeX": 4,
    "sizeY": 4,
    "resources": [
      {
        "url": "https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      },
      {
        "url": "https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      },
      {
        "url": "https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      }
    ],
    "templateHtml": "<div class=\"camera-widget\">\n  <div class=\"camera-header\">\n    <div id=\"cameraTitle\" class=\"camera-title\"></div>\n    <label class=\"camera-switch-label\">\n      <input id=\"switchCheckbox\" type=\"checkbox\" class=\"camera-switch-checkbox\">\n      <span class=\"camera-switch-slider\"></span>\n    </label>\n  </div>\n  <div class=\"camera-container\">\n    <video id=\"webcamVideo\" autoplay playsinline class=\"responsive-video\" style=\"display:none;\"></video>\n    <div id=\"placeholderIcon\" class=\"hidden-placeholder\">\n      <i class=\"bi bi-eye-slash\"></i>\n    </div>\n  </div>\n</div>",
    "templateCss": ".camera-widget {\n  display: flex;\n  flex-direction: column;\n  height: 100%;\n  background-color: #fff;\n  border: 1px solid #e0e0e0;\n  border-radius: 8px;\n  overflow: hidden;\n}\n.camera-header {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  padding: 10px 12px;\n  background-color: #f8f9fa;\n  border-bottom: 1px solid #ddd;\n}\n.camera-title {\n  font-family: 'Trebuchet MS', sans-serif;\n  font-size: 1rem;\n  font-weight: 600;\n  color: #333;\n}\n/* Toggle switch CSS */\n.camera-switch-label {\n  position: relative;\n  display: inline-block;\n  width: 40px;\n  height: 20px;\n}\n.camera-switch-checkbox {\n  opacity: 0;\n  width: 0;\n  height: 0;\n}\n.camera-switch-slider {\n  position: absolute;\n  cursor: pointer;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  background-color: #ccc;\n  border-radius: 20px;\n  transition: 0.2s;\n}\n.camera-switch-slider:before {\n  position: absolute;\n  content: '';\n  height: 16px;\n  width: 16px;\n  left: 2px;\n  top: 2px;\n  background-color: white;\n  border-radius: 50%;\n  transition: 0.2s;\n}\n.camera-switch-checkbox:checked + .camera-switch-slider {\n  background-color: #5CC489;\n}\n.camera-switch-checkbox:checked + .camera-switch-slider:before {\n  transform: translateX(20px);\n}\n.camera-container {\n  position: relative;\n  flex-grow: 1;\n  background-color: #000;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n}\n.responsive-video {\n  width: 100%;\n  height: 100%;\n  object-fit: cover;\n}\n.hidden-placeholder {\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  width: 100%;\n  height: 100%;\n  color: #6c757d;\n  font-size: 3rem;\n}\n",
    "controllerScript": "self.onInit = function() {\n  const ctxScope = self.ctx.$scope;\n  const settings = self.ctx.settings || {};\n  // Khởi tạo title và switchState\n  ctxScope.title = settings.title || 'Hidden Camera';\n  ctxScope.switchState = settings.initialValue === true;\n  \n  // Gán nội dung title vào DOM\n  setTimeout(function() {\n    document.getElementById('cameraTitle').innerText = ctxScope.title;\n    const checkbox = document.getElementById('switchCheckbox');\n    const videoEl = document.getElementById('webcamVideo');\n    const placeholder = document.getElementById('placeholderIcon');\n    if (checkbox) {\n      checkbox.checked = ctxScope.switchState;\n      checkbox.addEventListener('change', onToggle);\n    }\n    // Nếu initialValue = true thì mở camera ngay\n    if (ctxScope.switchState) {\n      openCamera();\n      if (videoEl) videoEl.style.display = 'block';\n      if (placeholder) placeholder.style.display = 'none';\n    }\n  }, 0);\n};\n\nself.onDataUpdated = function() {\n  // Không cần subscription\n};\n\nfunction onToggle(event) {\n  const checked = event.target.checked;\n  const videoEl = document.getElementById('webcamVideo');\n  const placeholder = document.getElementById('placeholderIcon');\n  if (checked) {\n    openCamera();\n    if (videoEl) videoEl.style.display = 'block';\n    if (placeholder) placeholder.style.display = 'none';\n  } else {\n    stopCamera();\n    if (videoEl) videoEl.style.display = 'none';\n    if (placeholder) placeholder.style.display = 'flex';\n  }\n  // Cập nhật lại scope và detectChanges\n  self.ctx.$scope.switchState = checked;\n  self.ctx.$scope.title = self.ctx.$scope.title || 'Hidden Camera';\n  self.ctx.detectChanges();\n}\n\nfunction openCamera() {\n  const videoEl = document.getElementById('webcamVideo');\n  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {\n    navigator.mediaDevices.getUserMedia({ video: true, audio: false })\n      .then(function(stream) {\n        if (videoEl) {\n          videoEl.srcObject = stream;\n          videoEl.play();\n        }\n      })\n      .catch(function(err) {\n        console.error('Cannot access webcam:', err);\n      });\n  } else {\n    console.error('Browser does not support getUserMedia.');\n  }\n}\n\nfunction stopCamera() {\n  const videoEl = document.getElementById('webcamVideo');\n  if (videoEl && videoEl.srcObject) {\n    const tracks = videoEl.srcObject.getTracks();\n    tracks.forEach(function(t) { t.stop(); });\n    videoEl.srcObject = null;\n  }\n}\n",
    "settingsSchema": "{\n  \"schema\": {\n    \"type\": \"object\",\n    \"title\": \"Settings\",\n    \"properties\": {\n      \"title\": { \"title\": \"Title\", \"type\": \"string\", \"default\": \"Hidden Camera\" },\n      \"initialValue\": { \"title\": \"Initial On/Off\", \"type\": \"boolean\", \"default\": false }\n    }\n  },\n  \"form\": [\"title\", \"initialValue\"]\n}\n",
    "dataKeySettingsSchema": "{}\n",
    "settingsDirective": "",
    "defaultConfig": "{\"showTitle\":false,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0,0,0,0.87)\",\"padding\":\"0px\",\"settings\":{\"title\":\"Hidden Camera\",\"initialValue\":false},\"title\":\"Camera Viewer (Preserve UI)\",\"dropShadow\":false,\"enableFullscreen\":true,\"enableDataExport\":false,\"widgetStyle\":{},\"widgetCss\":\"\",\"pageSize\":1024,\"noDataDisplayMessage\":\"Cannot load webcam\"}"
  },
  "tags": null
}
